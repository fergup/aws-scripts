#!/bin/bash
###################################################################################
#
# mnz_p1p2_phone.sh
# -----------------
# Calls Strategic Accoutns managers whenever a P1 or P2 ticket appears for Menzies
#
# Version Control
# ---------------------------------------------------------------------------------
# | Version |   Date   | Author | Comments
# ---------------------------------------------------------------------------------
# |   1.0   | 13/05/16 |  PRF   | First edition
# ---------------------------------------------------------------------------------
# 
###################################################################################
# Set variables
#
TIXDIR=/data/sn
P1FILE=$TIXDIR/MenziesXP1XP2.csv
#
# Set up a function to call out
#
call() {
curl -X POST -F 'FirstName=Paul' -F 'destination=07810853162' -F 'message=Menzies have a new P1 or P2 ticket' http://myfone.io/apiCall/02f95a87-1752-11e6-87b0-00163ebbe4b1
curl -X POST -F 'FirstName=Stuart' -F 'destination=07715634332' -F 'message=Menzies have a new P1 or P2 ticket' http://myfone.io/apiCall/02f95a87-1752-11e6-87b0-00163ebbe4b1
# Send emails
mutt "paul.ferguson@sungardas.com,stuart.brook@sungardas.com,ian.mitchell@sungardas.com" -s "!!! URGENT Menzies P1 URGENT !!!" <$P1FILE
# Send SMS
curl -X POST -F 'FirstName=Paul' -F 'destination=+447810853162' -F 'message=Menzies P1 or P2 Incident logged' http://myfone.io/apiSMS/02f95a87-1752-11e6-87b0-00163ebbe4b1
curl -X POST -F 'FirstName=Stuart' -F 'destination=+447715634332' -F 'message=Menzies P1 or P2 Incident logged' http://myfone.io/apiSMS/02f95a87-1752-11e6-87b0-00163ebbe4b1
echo \"PhoneCallMade\" >> $P1FILE
}
#
# Check tickets and call
#
#[[ `grep PhoneCallMade $P1FILE` ]] || [[ `cat $P1FILE|awk -F'","' '($7!~"Resolved")&&($7!~"state") { print}'` ]] || call
case $(grep PhoneCallMade $P1FILE;echo $?) in
	0) exit
	;;
	1) [[ `cat $P1FILE|awk -F'","' '($7!~"Resolved")&&($7!~"state")&&($7!~"Closed") { print}'` ]] && call
	;;
esac
