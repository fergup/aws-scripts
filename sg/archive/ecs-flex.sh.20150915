#!/bin/bash
###################################################################################
#
# ecs-flex.sh
# ----------
# Calculates flex overages on ECS
#
# Version Control
# ---------------------------------------------------------------------------------
# | Version |   Date   | Author | Comments
# ---------------------------------------------------------------------------------
# |   1.0   | 09/09/15 |  PRF   | First edition
# ---------------------------------------------------------------------------------
#
###################################################################################
# Set variables
#ECSFILE=/data/edison.csv
ECSFILE=$(ls -atr /data/flex/flex* |tail -1)
ECSFILEBASE=$(basename $ECSFILE)
COMPS=/data/sn/EuropeXAllXCompanies.csv
ECSOUT=/data/mail/ecs-out.csv
ECSMAIL=/data/mail/ecs-mail
RRDDATE=$(date +%m/%d/%Y" "%H:%M)
RRDFILE=/data/rrd/uk_flex.rrd
RRDGRAPHCPU=/data/images/flex_cpu.png
RRDGRAPHMEM=/data/images/flex_mem.png
RRDGRAPHSTRG=/data/images/flex_strg.png
RRDGRAPHVMS=/data/images/flex_vms.png
# Set totals to Zero
FLEXCPUTOT=0
FLEXMEMTOT=0
FLEXSTRGTOT=0
FLEXVMSTOT=0
FLEXPRETOT=0
# Process info and generate output
#echo "snt,name,Contracted CPU,Used CPU,CPU in flex,Contracted Memory,Memory in Use,Memory in flex,Contracted Storage,Storage in Use,Storage in flex,Contracted Prod VMs,Prod VMs in use,Contracted Prod VMs in flex,Contracted Pre-prod VMs,Pre-prod VMs in use,Pre-prod VMs in flex, Account Manager"
echo "snt,name,CPU in flex,Memory in flex,Storage in flex,Contracted Prod VMs in flex,Pre-prod VMs in flex,Service Manager" > $ECSOUT
echo "" > $ECSMAIL
printf "<head><style>
        table {
                border-collapse: collapse;
                font-family: Arial;
                font-size: 14;
                text-align: Center;
        }
        table, th, td {
        border: 1px solid black;
        }

td {
    vertical-align: bottom;
        padding: 5px;
        font-family: Arial;
}

td.dclass {
        margin-left: auto;
    margin-right: auto;
    vertical-align: bottom;
        padding: 5px;
        text-align: Center;
        font-family: Arial;
        font-size: 14;
}

th {
        margin-left: auto;
    margin-right: auto;
    vertical-align: bottom;
        padding: 5px;
        text-align: Center;
        font-family: Arial;
        background-color: #FF9897;
}

</style></head><body>
" >> $ECSMAIL
echo "<html><span style='font-family:arial;text-align: center'><table border='1'><tr bgcolor="59FD61"><b><td>Customer SNT</td><td>Customer Name</td><td>CPU in Flex</td><td>Memory in flex (GB)</td><td>Storage in flex (GB)</td><td>Contracted Prod VMs in flex</td><td>Pre-prod VMs in flex</td><td>Service Manager</td></b></tr>"  >> $ECSMAIL
for CUSTOMER in $(awk -F'|' '{ print $2 }' $ECSFILE|sort|uniq|egrep -v "aslg|astl|ecas|ecpm|ecuc|gaul|gsbl|iisa|in1r|peuc|qlil|sas7|sgns|su4a|su5o|su5p|su5q|tr0h|ukp0|ydep")
	do
	CONCPU=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $4 }'|paste -sd+ - | bc)
	CONMEM=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $5 }'|paste -sd+ - | bc)
	CONSTRG=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $6 }'|paste -sd+ - | bc)
	CONVMS=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $7 }'|paste -sd+ - | bc)
	CONPRE=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $8 }'|paste -sd+ - | bc)
	USECPU=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $14 }'|paste -sd+ - | bc)
	USEMEM=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $15 }'|paste -sd+ - | bc)
	USESTRG=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $16 }'|paste -sd+ - | bc)
	USEVMS=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $17 }'|paste -sd+ - | bc)
	USEPRE=$(grep $CUSTOMER $ECSFILE |awk -F'|' '{ print $18 }'|paste -sd+ - | bc)
	FLEXCPU=$(($USECPU - $CONCPU)); [[ $FLEXCPU -gt 0 ]] && FLEXCPUTOT=$(($FLEXCPUTOT + $FLEXCPU))
	FLEXMEM=$(($USEMEM - $CONMEM)); [[ $FLEXMEM -gt 0 ]] && FLEXMEMTOT=$(($FLEXMEMTOT + $FLEXMEM))
	FLEXSTRG=$(($USESTRG - $CONSTRG)); [[ $FLEXSTRG -gt 0 ]] && FLEXSTRGTOT=$(($FLEXSTRGTOT + $FLEXSTRG))
	FLEXVMS=$(($USEVMS - $CONVMS)); [[ $FLEXVMS -gt 0 ]] && FLEXVMSTOT=$(($FLEXVMSTOT + $FLEXVMS))
	FLEXPRE=$(($USEPRE - $CONPRE)); [[ $FLEXPRE -gt 0 ]] && FLEXPRETOT=$(($FLEXPRETOT + $FLEXPRE))
	NAME=$(grep -w $CUSTOMER $COMPS |awk -F, '{ print $1 }'|sed 's/"//g')
	ACCTMGR=$(grep -w $CUSTOMER $COMPS |awk -F, '{ print $19 }'|sed 's/"//g')
	[[ $FLEXCPU -gt 0 ]] && FLEXCPUCOL="red"||FLEXCPUCOL="white"
	[[ $FLEXMEM -gt 0 ]] && FLEXMEMCOL="red"||FLEXMEMCOL="white"
	[[ $FLEXSTRG -gt 0 ]] && FLEXSTRGCOL="red"||FLEXSTRGCOL="white"
	[[ $FLEXVMS -gt 0 ]] && FLEXVMSCOL="red"||FLEXVMSCOL="white"
	[[ $FLEXPRE -gt 0 ]] && FLEXPRECOL="red"||FLEXPRECOL="white"
#echo "$CUSTOMER,$NAME,$CONCPU,$USECPU,$FLEXCPU,$CONMEM,$USEMEM,$FLEXMEM,$CONSTRG,$USESTRG,$FLEXSTRG,$CONVMS,$USEVMS,$FLEXVMS,$CONPRE,$USEPRE,$FLEXPRE,$ACCTMGR"
echo "$CUSTOMER,$NAME,$FLEXCPU,$FLEXMEM,$FLEXSTRG,$FLEXVMS,$FLEXPRE,$ACCTMGR" |awk -F, '($3>0)||($4>0)||($5>0)||($6>0)||($7>0) { print }' >> $ECSOUT
echo "<tr><td>$CUSTOMER</td><td>$NAME</td><td bgcolor="$FLEXCPUCOL">$FLEXCPU</td><td bgcolor="$FLEXMEMCOL">$FLEXMEM</td><td bgcolor="$FLEXSTRGCOL">$FLEXSTRG</td><td bgcolor="$FLEXVMSCOL">$FLEXVMS</td><td bgcolor="$FLEXPRECOL">$FLEXPRE</td><td>$ACCTMGR</td></tr>" |grep  "bgcolor=red" >> $ECSMAIL
done
echo "<tr bgcolor="FFFFCC"><b><td>Total</td><td>-</td><td>$FLEXCPUTOT</td><td>$FLEXMEMTOT</td><td>$FLEXSTRGTOT</td><td>$FLEXVMSTOT</td><td>$FLEXPRETOT</td><td>-</tr>" >> $ECSMAIL
echo "</table>" >> $ECSMAIL
printf "
Data based on $ECSFILEBASE" >> $ECSMAIL
# Update RRD
rrdtool update $RRDFILE "$RRDDATE@$FLEXCPUTOT:$FLEXMEMTOT:$FLEXSTRGTOT:$FLEXVMSTOT:$FLEXPRETOT"
rrdtool graph $RRDGRAPHCPU -a PNG --title="ECS CPU Flex (UK)" --vertical-label "CPUs" 'DEF:probe1=/data/rrd/uk_flex.rrd:cpu:AVERAGE'  'AREA:probe1#FF0000:CPU'  -w 600 -h 250 -n TITLE:13: --alt-y-grid -l 0 -s now-1w -e now
rrdtool graph $RRDGRAPHMEM -a PNG --title="ECS Memory Flex (UK)" --vertical-label "GB" 'DEF:probe1=/data/rrd/uk_flex.rrd:mem:AVERAGE'  'AREA:probe1#00FF00:Memory'  -w 600 -h 250 -n TITLE:13: --alt-y-grid -l 0 -s now-1w -e now
rrdtool graph $RRDGRAPHSTRG -a PNG --title="ECS Storage Flex (UK)" --vertical-label "GB" 'DEF:probe1=/data/rrd/uk_flex.rrd:strg:AVERAGE'  'AREA:probe1#00FFFF:Storage' -w 600 -h 250 -n TITLE:13: --alt-y-grid -l 0 -s now-1w -e now
rrdtool graph $RRDGRAPHVMS -a PNG --title="ECS VMs Flex (UK)" --vertical-label "VMs" 'DEF:probe1=/data/rrd/uk_flex.rrd:vms:AVERAGE' 'AREA:probe1#000000:VMs' -w 600 -h 250 -n TITLE:13: --alt-y-grid -l 0 -s now-1w -e now
# Email report
mutt -e 'set content_type="text/html"' "paul.ferguson@sungardas.com,paul.labbett@sungardas.com" -s "ECS flex report" -a $ECSOUT < $ECSMAIL
#mutt -e 'set content_type="text/html"' "paul.ferguson@sungardas.com" -s "ECS flex report" -a $ECSOUT -a $RRDGRAPHCPU -a $RRDGRAPHMEM -a $RRDGRAPHSTRG -a $RRDGRAPHVMS < $ECSMAIL
