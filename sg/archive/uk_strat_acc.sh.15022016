#!/bin/bash
###################################################################################
#
# uk_strat_acc.sh
# -----------------
# Takes input from Service Now reports and processes them for daily report to TOC
# management to track open Incidents, based on global_open.sh
#
# Version Control
# ---------------------------------------------------------------------------------
# | Version |   Date   | Author | Comments
# ---------------------------------------------------------------------------------
# |   1.0   | 13/02/16 |  PRF   | First edition
# ---------------------------------------------------------------------------------
# 
###################################################################################
# Set variables
TIXDIR=/data/sn
STRATDIR=/data/strat
ALLEURTIX=$TIXDIR/GlobalXOpenXIncidentsXPFXExport.csv
ALLTIX=$TIXDIR/UKXOpenXINCXCHGXRITM.csv
CLOSED=$TIXDIR/UKXClosedXYesterdayXINCXCHGXRITM.csv
DATE=$(date +%Y-%m-%d" "%H:%M:%S)
DDATE=$(date +%b" "%d)
FILEDATE=$(date +%d%b%Y)
datediff() {
     d1=$(date -d "$1" +%s)
     d2=$(date -d "$2" +%s)
     echo $(( (d1 - d2) / 86400 )) days
}
IFS='"'
# Incidents
TIXDIR=/data/sn
OPEN=$TIXDIR/GlobalXOpenXIncidentsXPFXExport.csv
CLOSED=$TIXDIR/UKXClosedXYesterdayXINCXCHGXRITM.csv
CHDATE=$(date +%d" "%b)
IFS='"'
INCFILE=$STRATDIR/incidents
REQFILE=$STRATDIR/requests
CHGFILE=$STRATDIR/changes
AVAILFILE=$STRATDIR/availability
TEMPLATE=$STRATDIR/template
MAILFILE=$STRATDIR/strat-$FILEDATE.html
# Incidents
UKINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($10!~/FR |IE |SE /) { print $6 }' |wc -l)
IEINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($10~"IE ") { print $6 }' |wc -l)
SEINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($10~"SE ") { print $6 }' |wc -l)
FRINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($10~"FR ") { print $6 }' |wc -l)
MNZINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($12~"Menzies") { print $6 }' |wc -l)
SERCOINC15=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600)&&($12~"Serco") { print $6 }' |wc -l)
UKINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($10!~/FR |IE |SE /) { print $6 }' |wc -l)
IEINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($10~"IE ") { print $6 }' |wc -l)
SEINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($10~"SE ") { print $6 }' |wc -l)
FRINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($10~"FR ") { print $6 }' |wc -l)
MNZINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($12~"Menzies") { print $6 }' |wc -l)
SERCOINC7=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>604800)&&($12~"Serco") { print $6 }' |wc -l)
UKINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($10!~/FR |IE |SE /) { print $6 }' |wc -l)
IEINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($10~"IE ") { print $6 }' |wc -l)
SEINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($10~"SE ") { print $6 }' |wc -l)
FRINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($10~"FR ") { print $6 }' |wc -l)
MNZINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($12~"Menzies") { print $6 }' |wc -l)
SERCOINC30=$(cat $ALLEURTIX |awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>2592000)&&($12~"Serco") { print $6 }' |wc -l)
#
# Changes - all and late for each are
#
unset IFS # The Change stuff gets upset by the IFS setting
IECHGALL=$(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"IE ") { print }'|wc -l)
IECHGLATE=$(for i in $(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"IE ") { print $22 }'|sed 's/"//g'); do echo $i;datediff "$DATE" "$i"; done |grep days |sed 's/days//g'|awk '($1 >= 30) { print $1 }'  |wc -l)
SECHGALL=$(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"SE ") { print }'|wc -l)
SECHGLATE=$(for i in $(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"SE ") { print $22 }'|sed 's/"//g'); do echo $i;datediff "$DATE" "$i"; done |grep days |sed 's/days//g'|awk '($1 >= 30) { print $1 }'  |wc -l)
FRCHGALL=$(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"FR ") { print }'|wc -l)
FRCHGLATE=$(for i in $(cat $ALLTIX |awk -F'",' '($21~"Change")&&($2~"FR ") { print $22 }'|sed 's/"//g'); do echo $i;datediff "$DATE" "$i"; done |grep days |sed 's/days//g'|awk '($1 >= 30) { print $1 }'  |wc -l)
MNZCHGALL=$(cat $ALLTIX |awk -F'",' '($21~"Change")&&($7~"Menzies") { print }'|wc -l)
MNZCHGLATE=$(for i in $(cat $ALLTIX |awk -F'",' '($21~"Change")&&($7~"Menzies") { print $22 }'|sed 's/"//g'); do echo $i;datediff "$DATE" "$i"; done |grep days |sed 's/days//g'|awk '($1 >= 30) { print $1 }'  |wc -l)
SERCOCHGALL=$(cat $ALLTIX |awk -F'",' '($21~"Change")&&($7~"Serco") { print }'|wc -l)
SERCOCHGLATE=$(for i in $(cat $ALLTIX |awk -F'",' '($21~"Change")&&($7~"Serco") { print $22 }'|sed 's/"//g'); do echo $i;datediff "$DATE" "$i"; done |grep days |sed 's/days//g'|awk '($1 >= 30) { print $1 }'  |wc -l)
#
# Request tickets
#
IEREQ=$(cat $ALLTIX |awk -F'","' '($21~"Requested Item")&&($2~"IE ") { print }' |wc -l)
SEREQ=$(cat $ALLTIX |awk -F'","' '($21~"Requested Item")&&($2~"SE ") { print }' |wc -l)
FRREQ=$(cat $ALLTIX |awk -F'","' '($21~"Requested Item")&&($2~"FR ") { print }' |wc -l)
MNZREQ=$(cat $ALLTIX |awk -F'","' '($21~"Requested Item")&&($7~"Menzies") { print }' |wc -l)
SERCOREQ=$(cat $ALLTIX |awk -F'","' '($21~"Requested Item")&&($7~"Serco") { print }' |wc -l)

# Populate data files
printf "['$DDATE', $MNZINC7, $SERCOINC7, $SEINC7, $IEINC7],
" >> $INCFILE
printf "['$DDATE', $MNZREQ, $SERCOREQ, $SEREQ, $IEREQ],
" >> $REQFILE
#printf "['$DDATE', $MNZ7, $SERCO7, $SE7, $IE7]," >> $CHGFILE

# Create mail file
echo "" > $MAILFILE
head -12 $TEMPLATE >> $MAILFILE
tail -5 $INCFILE >> $MAILFILE
printf "   ]);
		
		 var data2 = new google.visualization.arrayToDataTable([
          ['Day', 'Menzies', 'Serco', 'Sweden', 'Ireland'],
" >> $MAILFILE
tail -5 $REQFILE >> $MAILFILE
printf "   ]);
		
		var data3 = google.visualization.arrayToDataTable([
        ['Country', 'Open Changes', 'Overdue Changes'],
['IE', $IECHGALL, $IECHGLATE ],
['SE', $SECHGALL, $SECHGLATE],
['Serco', $SERCOCHGALL, $SERCOCHGLATE],
['Menzies', $MNZCHGALL, $MNZCHGLATE]
     ]);
" >> $MAILFILE
sed -n 41,140p $TEMPLATE >> $MAILFILE
# Add top issues, etc
#head -1 $ALLEURTIX | awk -F'","' '{ print "<table border='1'><tr bgcolor="999999"><td>"$1"</td><td>"$10"</td><td>"$11"</td><td>"$4"</td><td>"$5"</td><td>"$9"</td><td>"$6"</td><td>"$7"</td><td>"$12"</td><td>"$21"</td></tr>" }';cat $ALLEURTIX | awk -F'","' '($18~"Incident")&&($5!~"Resolved")&&($20>1209600) { print "<tr><td>"$1"</td><td>"$10"</td><td>"$11"</td><td>"$4"</td><td>"$5"</td><td>"$9"</td><td>"$6"</td><td>"$7"</td><td>"$12"</td><td>"$21"</td></tr>"}'|sed 's/"//g'| grep $i; echo "</table></span><br>";done >> $MAILFILE


unset IFS
mutt -e 'set content_type="text/html"' "paul.ferguson@sungardas.com"  -s "### TEST Daily Strategic Accounts Dashboard TEST ###" -a $MAILFILE < $MAILFILE 
#mutt -e 'set content_type="text/html"' "paul.ferguson@sungardas.com,xande.craveiro-lopes@sungardas.com,jan.clayton-adamson@sungardas.com"  -s "### TEST Daily Global Open Ticket Report ###" < $MAILFILE 
